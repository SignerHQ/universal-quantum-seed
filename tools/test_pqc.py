# Copyright (c) 2026 Signer — MIT License

"""Test suite for post-quantum cryptography modules.

Tests ML-DSA-65 (FIPS 204) and SLH-DSA-SHAKE-128s (FIPS 205)
implementations, plus quantum seed derivation from seed.py.

Includes NIST ACVP known-answer tests (KATs) sourced from:
    https://github.com/usnistgov/ACVP-Server/tree/master/gen-val/json-files/

Run from the universal-quantum-seed root:
    python -m tools.test_pqc
"""

import os
import sys
import time
import unittest

# Ensure project root is on the import path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), ".."))


# ── NIST ACVP Test Vectors ───────────────────────────────────────

# ML-DSA-65 keygen vector (ACVP-Server ML-DSA-keyGen-FIPS204, tgId=2, tcId=26)
_ML_DSA_KEYGEN_SEED_26 = (
    "1BD67DC782B2958E189E315C040DD1F64C8AB232A6A170E1A7A52C33F10851B1"
)
_ML_DSA_KEYGEN_PK_26 = (
    "43AD6560D3BB684667A559EE6EC7C816020E5B65671F270F2353A8C912B6C26B"
    "0DB0C2CF42DC747B10AA3EBDD573B300EEA46C4200B210094F9512119A6BB837"
    "242762B2CE94C2467278500EE7B139BED906676663355B813A9AD9D3DB70F7AF"
    "2D785040BFD51208BD3D2CFB09EAF7CEDF77D1B59DA75F7728F120C11898D9EC"
    "2CB22C73EB8F9436FF60524B56EE6B413030EB7DD10774261452CD8C5ADE75D1"
    "967628078CDA77E2B1AFB83B9F07F6939D37FF54D5E10ED17FF8A3C21546A89F"
    "514576AE780DE8761C4F2EA28828C69E38C730ACAA4CC8DC7DF63BA4C1525510"
    "FAE2C8E1B01812358BC5DFC01E955294A5DFDD1CFF0519E20B8F74FE18854D8"
    "0C86051AA5CC2FC1DB078BC785BF4BAD6832B8C269156509B332038B4C3719DC"
    "49814FC6B6AD5360E945AFFF4D4AC235F56C7F7A9A872B518C1F0D48184DA0E"
    "B318F74EB84C4F324A2BD03704D2E2A59F64A8854C7AEFB2D3530E20C8AE8A4"
    "87E6CBEDA645BD86A5A83E77A6A22888ED8E43A7F4804C2DE187F1ACBA3CF55"
    "CF99412A7A59CF77A4A977724A72686FDF7FC64492A5CB75921AD014EB727EDA"
    "1DFA7BD7ACE52FE292322F0BE0B004DCE44BEAA20FF06A7691DC36405361F924"
    "0DDF2FD1A5EC422ED639505AB8E137B971D5729B11E84C040247424A51DDDBDB"
    "C43AF261D038B0CD70D5BF44252A3786A26AF3FCD4EC100E5CDDE019F17BE6A6"
    "4F820C3F622F78D4F56A984122D6FA2D438D548DD87B9095F1FF02437854E241"
    "9A0316C33EAFFA0161737E476A9E707CC40E78686D6A043DDE962B319BE2BF9F"
    "7A1EFF9EDEFD1B4CD07131494C084083BF76181E3EB1399929314473A75E199A"
    "C9D5444DB0CEC07E625EC70C6864093961950987FB1E96DCB7E001209865D66D"
    "829CD2E2B240818CACE003C9CC74DCE5151C65E59AC1EF6D495B0C717B4412C7"
    "0B50CF44F44E648788F46BAF6F8AF3361F0E4B6119EDF6374DA596453169B935"
    "E1A3B875A6C1B9FE384AF961860514E8CF291D8650D7530DB42A46790649B5D8"
    "134AAEC33A41F0AB4296AE26203291F1C2BB5276AC305269778E7F2A4BAC15B5"
    "A31A6B6B76342596D39C7FD3D1C518689372EBD20B667BE5EE2ED11BC107A760"
    "0EDA1BE7A5DC05BB9F16D2B8BB1C7D8D10050207530BFFDAAE7B11E0615726F2"
    "E99CE99D6CA6048F9D61B14F7265473EC2D02989772B3D7E212AA68D89374C6C"
    "AF7AB160C6C5E09502049C3D03738D700457F706341DDEAFC6CA739ECFB4F193"
    "EA6B385B035EEA0F7BFD61FA776AF32AED6366E6C0642D1A01759FA6BDD295F7"
    "D18CA6DA1D48563EEE403F2F8BCB6A60326C481F12F8180B2B8117ADE61C7E29"
    "F5254207C5D4657B82BE4EBA436752EC7DA0627FCED830C15F10FB8D3CD90B45"
    "05FA325B54D954C5B6301DA72B262B226EAB2E4EE88226CC606B97736260ECB6"
    "D8F74A0440AFD5D751A90873FFF00C8D3E9CA0975F303F7AC263B8FF496C6C8F"
    "D22E8EF7B587BAB50A7DAD99BD55D3B7968584F1FB21255EE22DB56AF6034F3F"
    "13E659161A57CA8C9F2E87CA96BD7100FCEF8F74A8C6A1C92E2EFF74E2F5FAE5"
    "12C09D26E0F3985D882401EFC54727BBC0F4E1110771A106898692D0C5A6997C"
    "A742846FA4D49E8ABDF123D92743E9949BEB6E46B9655EE698C23D74991C9606"
    "7DEF06EACB981AD4A7A5ED91EACF05D374C74C443F3FBAD363B2450A1A47AAF2"
    "954D36E53B06345139138D38B941298982EEA84400C4DCC38F5127951906EE3E"
    "40F75A5DFE09FCE9BB0143A5D5ADC3C402F23A75A423AB98392CA3A4D5D23D3B"
    "CD56FF22C9612A5D2C223C7079958CD05175AA74DDD21B42051CDBDC14048CB4"
    "3CB2F6535E2CA9F5B87052F633976F4795CBA69D39F2481CFB9D210C9B0E9EFD"
    "941AC875A9A6C3E839EC54F55585721DE41815DDFC05E8A58C97E2FA52984135"
    "AAB0931094FF8400CAB043C2A5E63C2942B7D36988C4ED9B73C11D913E758ADF"
    "94291A42743E4FB04C271ED5807EA03271EA6656CF967AB2595588B55F82AF2D0"
    "7ADFFCCF859ABA70B1707B722DA1FF393CC5BBCC02014C0D4500655577946DB5"
    "F95EF1E7657DC98402E5CB048DCB372C9277FDA4D8F3A30C953822474CEEDA67"
    "0D5E680029259260D91F8737CF7572651FB28A7DF46F671679BDD507696B021C"
    "2C7F4300F3098FF9460582DB58E122C585185BCD091E7ACCB608F7E0C3558627"
    "484529A662C0528D419248B6565D32ECC78F7891DB5BB1984CDE89C1AF25F092"
    "7205E734A7DFEB9AEE94F23F2FD11FB53EC768F6B8268E00E4054CD12EDE4832"
    "B07A254A4E2241854E8FF2AE1E1B248F9EB1C77581CA2A2EF2D4C9171177A1E0"
    "40F9D4AD8D0D0C6CD14FCD13B233794E51704B6890C56BCE1B8CD1C9EAE6D59A"
    "CD91EB67B3A618D65F0F94E5458271E14DC6F6530AD0EE8B2B2F0CEC14612E56"
    "3338E241602B997EC4E62C83942C7F18DAD6841B1348CAB99A78F598FE78A202"
    "05D88D826D2E163F6B628B266C187B427F253000E4EF99FEC0494A97D9B42E37"
    "EE613767D2651FB7CB2B9E99578CE2D78B9C9777C954DBD1D7BE8B568F88AB42"
    "DDFD293BE28747103B052AD81D8F6254E426802516500111ADF0A8F27AE7C55D"
    "3D5DB86278FAF58B68A26D12B2801AC28EDA87AA5D692EDA9BE08F7CC3E78517"
    "299A3FD9CE2A0A893E12D71062AE2514C465D399F165E4D2F71D1913D8B95396"
    "681486432B090F0CCE86AA84B661FF22D4A56035E821A1CE30F33AFEB6C7B8FA"
    "9CE"
)

# ML-DSA-65 sigGen vector (ACVP-Server ML-DSA-sigGen-FIPS204, tgId=3, tcId=31, deterministic)
_ML_DSA_SIGGEN_SK_31 = (
    "6CD5B575E6B85BFAD904C66BFDFDCA515265C07FB8CAAAC9C58C14FA9189D491"
    "7D7ACC758C92BAE70AB72903A2D3D4F5EDEFB2697A1430C5810BEDC137EC87EF"
    "FD2F79294AA74EB707F132B29820CD58093C1148FE6B636F7F80C72E777CCCE6"
    "E67A5CFAD97341EC995C734800363A1CE491F27196D4322105FF27AC79F5EFDA"
    "60286136357410664315776252752407756314210418571648561727268700255287"
    "331236121354365001312775767584417644322504438305111081081876026500"
    "654012713480234146182725452405316353262722273863410527682651124313"
    "617146446468763236572883683851341282053215280254740235060240850324"
    "440831272573070217326674074611777265230057000463320626533826567723"
    "546684641261361172168832416838732447000175761817884001281870505407"
    "105812083630737534234530861250140743370224166472407765428621832254"
    "533851825264762141805273862831542318003602217553874083033871231474"
    "334805553540646834361857872362721013221315154377872114283633878107"
    "148570865127122771168256788832101555628657835804815235874745320114"
    "807487105725084663633033803220002386732063125810014872862486470502"
    "711416681616285435121472675503862754211810321427030205205151784308"
    "515804520800815815621271243672214035840044743678671721546435280428"
    "360607411178157452818316372232228180847276018025186046848421146613"
    "878205377117430604356813752082000437482312436831350318874685743708"
    "464351030201325646754325872871813531455235084875066570454543830315"
    "562787262525176730227526028676753881604861747536478534804518058527"
    "772888625364743737287676713036472565548446734032381158814262076873"
    "388618386078707317050720550177184732830648637817255782143057163548"
    "418323678564081226478700114455204132122608250842301411343377243435"
    "642624754480243702417402034430237738751184615413645850651437310878"
    "848363433552805188824680247181748566622318774112322735758822785036"
    "370714450476606476010614485707027667281708801162671051001030832448"
    "207347701454665270803130540515341131722457166323840303066467002516"
    "864388122301818603411120171217517454770816548534057721877862545820"
    "644757227243578212845808300336088613441656388471213663804218601803"
    "754106013385414248661742532334208533626140056135648842078201883735"
    "074336525845347054132164800037145561552756104552631133011157715447"
    "235321406074057154263833247258731718347077202106654146544828447752"
    "640468250387231743704731012778573033613185030263185552167218032655"
    "242723205406266851367253811856371232418885125236384818716284884477"
    "010142585871436513052173017334732003261886333314274132286417376656"
    "676314711082686504118838381531507880205637004247774506481027824803"
    "432615228103572113440343856084084634237410518248520551127252336606"
    "736681557544383203111717630853205656516254475022421555881170337323"
    "534030806477563736665682820467542048717825503372863768782825134682"
    "228448434164234128341762458073372872621434547631605046447337267783"
    "236163514344622370473848833703522532828266357366354338217661800012"
    "375772585805638876304750873106124683373681371476321454728058642283"
    "077630656787704536321600871220523360851484085556121243080563345556"
    "887726833701276552087240210410034001060083231627367513775415156238"
    "517581201600130362012616084521565120517266780077748318503536524248"
    "147808167770656334505577640785201013333135BAE3FEF07D33D7B9842E4FB"
    "D3F6D285AA6B47EFA4A065158F0657A04BF437A7839C426766CC9C0849273F70"
    "5D9D63DF0E7DAA9849A312878BAD7D9FE7A9881F28D7B8646917C10C4FFE8C51"
    "DACE5BF6D5130EA118FAF211990D6AF646D26672F1AB2F69F2660D5868D95E01"
    "C8122DDCDEF420EA8815D4CE0B3D6D85684078279089A3DFD7755CAA106A2C6B"
    "4FCF17D029C85A95D1DAA7AEA75FE513C1CD73E8797A12D1494CA21FC317F9F0"
    "EAF256A61708889BBD22FE29FAD2D092E781E36F62DE70A7474145E2EB968004"
    "A3A6F46243D05682B830EFD54386753758B013C3D56F6810F3020B38F53113B6"
    "F686F0A1278E51DF2984EE3A6BEF27E8F7D1939CC37EA92022ECD1408DCBDFAB"
    "FD590325F7FC52711B7500117F0098C96143EB1A2EBFED3324FCCB6BAA53DC4B"
    "AC6CC16AA4622C94EA05B9513F9E6EB29C48682F906F81272E96CE317D869687"
    "F2AD80022A92F27F5411D547DA54D315EBE877F9DD20A74FE2F3FDEEE7296554"
    "CBD7A995E4813632F1D12965A8AE65FC3B9E8A31414A02CB084271F15669D3B9"
    "7273D8D5F4B437028C0BC0CCCEC3F4A5C7B9159E377C9578992C364B59D85AE3"
    "3BA6040A92B651BCEB410B45F5CF5597685256EDE85089C10AD26E1CBD5424E8"
    "68ECC250BDE1924613636D5534EE62C21814BD47CD558489AB9431B9594A08D6"
    "EE8252CD00E252F4DAB2DBC15B946E2C30C099AA9186ECF097BD0983E788A4C1"
    "393BFAF1648C7F20FB9D663E3A5512940F0069CFDB6077BF3D68770F36546BBF"
    "94439F0C298D5D5A0766DCA829CCB33A6F528746D370C1349C39030C462E03C8"
    "F7917C7E2B2A270FF43159C786BF1FBB9C16337F3799E2FDB382A33CB296CF85"
    "C5B947AE8A8FAC49EF4A493FAD541C81BC6C91E9821D830B6654DCC87A86EEF1"
    "55DDF00FDEC305EEF1F78FB00F5085058942A230CBACE95388F879729CE08D7F"
    "8B8BAE1E255D9B987CEAA10DD72D0EDF01832875A50FA34326EE0FE91314212A"
    "682451CDC1F4FE029D051E26678C1259E022A34DBA1606A445FDB38CCA2E3BA5"
    "66ADF56CE927D66A662DC5C27CB4152BC3E7182B36EF7A3E67F02A19AEA43A30"
    "88E7035FE0C92D4BFF9E75B7046BF862979DCC19C9B7E7434C4E6DE990C08FCC"
    "0F1DB9786AB53189DE247AD40F2239E378C19CF66B55E596AFBC90DE4917D3D4"
    "FD2D0900EC361F40A332DC5B05BE1F7FA7B55284736F4F7BBF9643D8C3E592FF"
    "065732C0AEE5C8F15FA998D77FEADA4F1743189C714149788B7E2CDC9C34C64C"
    "7217BAA52FE288DBEED183487B7E5D135FE56B989AC619F6A771CA8C6DA5D780"
    "CC02BE40D2DCC55E4FE4CA9171EEEA766C20AEAD36EA72F756D2E76C4BFA730F"
    "329CD1E36250BE6E79C0923779A74C8C792E98506D583E71870EE53E190333F8"
    "30E6E276C84DA25974B3C6D7BFFBF1DAB2A53655E005EFC4C29392C851F14CAA"
    "A17F3DD53CDDCBAC0280A47ABAF1F466C9A2B960A40501D100A659E7FE0B9C67"
    "75E8ED966AE3ECFE2D3C7E90EA8ACA6274BDADFE05DB229E3564E5647FBFBEAE"
    "A9962231D3808360565785B0C3B3F713DC0860A897EA43605FF11514AA26351021"
    "E3D469605F49522B6B3E5726FAECD59881B32F5D5FB609ABF5F282D715B8FD88"
    "FC87B280732142EA8FDB0FE25D33758572493A207AAD4D29D36DB979F3B34606"
    "F5BA3C70F2DDB60DD84B056864B59DDB3CC651960884BCB2D2F3490F3BF7EC98"
    "1F9F5C11D061642018F68DDFCE55BD59E22314349470EB70BE3F5CC31C6ECACC"
    "E6601F53AC990139385653345C335A54E16B91E5CCCD56A182981EBDF05C22A2"
    "E9F51C848FC306D9B78E99C21A1E094E8F4D8D5AA412109FE79DC58C002BC75D"
    "B3653111385E2D2C99C73A8B7D50233FEFF2FFB4BE26A04D85D05FD851746AFE"
    "0517C00EF3D930A66E119EE45C5DE23E6C2B050D7ECBF74C13BD0C6108AB2CE5"
    "76101EE88DD908E725A6CE1A1C090C6A8570174DC73F08B5139C04E71064A43D"
    "AF9DD2B4D1812390E97777CE6CA8F4FE547463C866D02DF77A9AA540E4AA7596"
    "A359800A835E4E2D23534BBEC0873242C14D95C2B14BD33D4B901CA4D4B12BE2"
    "CD53C7FA6367BE214A735ADF5844F7F3118D0CDF0ECED6095E365E4D18463726"
    "EA9FD9943C7A57F65B3450ABF855833E5AC1D97C735DC8B902760393986782F7"
    "B0833C139A86F0258701F9A65B07DF842A3F9C7550A91A94523B1431E6919ED0"
    "8A2C4CE0E764907B745F8273B6B003618085A34A37779FF9D971DC4138E28335"
    "D6BB9B4808C0AE2DB039259D46C418366A8D81BF1AE0194E8E88E471473BA163"
    "C9FF93AC4B0E4236CF4DE6B68D5A67BCEC87F9D9C236EAC2DCEA379BCA0721D2"
    "41835AFF9CDBF5289148155D077A92D67A5916949A972EC12378B015F4F60815"
    "AA18DEA20B89F8E342458DDA03A7211EA8F1150A486A5774FDB17B81D0F806C9"
    "B3CC4CDFECFDAA4D3FEDF6191C071FA30F4DD738198AC603C14BD8EE8E00F8B6"
    "EB52E3C52099ED2D338B841088563117FA33909D3ECC64A4DC26A09FE2A52269"
    "AC3142B1061742D7F294DC78E288A8BD6CBF342C3C8CB75D5D409CD6C7545D12"
    "E21DC2D5F4A0B232E50A2E55E1129442740521F6D380E1903FC00B8FB16D7C48"
    "FD1813A729C7B1B3D20F01F86F2C63FDE04C874800BC18697DAA19279DA9C359"
    "71D1CE6C42DAC2F488F07BE41DCE4B0140BA9C15CA6D077291C7494937DBED00"
    "28FAE8E1BD690C5992358279C671BF8CF0C230493604E0F75D6289C71C23A72E"
    "BE49866BF09072E8BF796BFF8BEC5B1426DF55E570EE4E48EE510D511706870F"
    "E3EC320F63AA1BA2F974FA9A97E3464C4352EBC8C1104114B4338904A2103ED4"
    "AB8ABC915D9397623E0B0ED842FC7B7C3DC8F890DE491CAAA7E5DA53F5A45FBF"
    "4AD4E850380FE7784EF174A9EA6F7983C3CC999559B5D8AF0467F135F4DDBF7E"
    "76CDBE8D89163DBE2402B5DAADEDAA1D8D0526DBCF7A4F68BD2D375B4E0F1214"
    "8C7FFD5C2D4BFD6A09FB47E66BD0B38CA3EDA4FC31955E46DE9B5D8E54C7660C"
    "C1DD46B16201FB44453687DD69B7B3F478CD77E5C98168229D259F84D4F02C290"
    "B01BFA372E471D7E66BEC67FB69FABAB568DB55DA1877D73749593953B2EA002B"
    "F2377CE235E18827C9C954B28DAC0B5650464EE005E906748E44382DCF9042E20"
    "DF3E80EE38D375043E457AF2FD13CF4F5C9CE98501E1AB1D97CA0EEC80D79B13"
    "D80ACB423996DB5CA315951EB2249F0F131118DCACBB762A99D1874ABBA59AC2"
    "828C1B8B9DF1043C00D267D9D5CAC1334DDDCD625F15625C8A287835867118709"
    "CF4CF7516FA1CF5F2E7A4404C5699118C52426C24B5BC45D3797B5C00605AD6C"
    "D1C302CC47451B433CF9896FCC23F89D295EB38B7D5D652A2E565D7BC2AAD801"
    "4A6FBA5A4CA06242C6B4AAC53FC3B464892DDBC6D0D8B4F55997BCE919690D23"
    "F56B7A8D552D5944A2F5385BF602122942193ABB3FA275FFF850FC565532BC83"
    "78F5059E3FAE22C4319D32DA76D99312274"
)
_ML_DSA_SIGGEN_MSG_31 = (
    "A54CB4BF79DDCE7D7C446F972A849DC3C75917E7ED52777590D49BA28A8171B1"
    "07650CC74348C2FD5AA5327FED13BBDF514ECCD477F4D5B213F8083CDB2923AF"
    "C35DABE663EE12932E8FDCC3058B6D991176CBAD"
)
_ML_DSA_SIGGEN_CTX_31 = (
    "0A8B9249C5794768EF495AF6483C80047295783A33DBB8B1"
)
_ML_DSA_SIGGEN_SIG_31 = (
    "E47D117DF51F7B54875CEA55017BE42F1DB20373EFC790331516CFFC243D8C18"
    "A542DD5EF98D3479758B1C598DC33E38D1497EA9A7AB23D79BBCEAC734F25C2C"
    "24D0DF4AD754DD85A4213D429DF2359BCBFDA28A5A3FE34017F24405F6B84684"
    "A3FE93C8C782C2EAA76864F197A3EF09A1F8D9F47BDB0343DFDC3672D6EE48D"
    "30ADF6E8F7217C9DA9C65F372706B939B755BA8BE1B5F23BC317369F710FB6CB"
    "EC0DE00F10C0E9213020551E3FB6E7F9067C1FD08440FDA6664BDD50228A642A"
    "A6237A815F2900B218193BD36BD04EF8F4DB9B1CF23FF9E685794B37C7B61B19"
    "8A393AD1DF702DA8110F3E0CA00C12121267D721F226FD5D6CD1F92A455F6568"
    "E420C1F547BEDC5306E2B71BF8CAB6C58E6024733649F03C0379C9CF20365966"
    "E3489E0A15727841D48E8C4145557A62E6A882F1DC2C0ACF0818382EE8BCF01F"
    "B70D0BF4208828619B10B3F0CEC9041A8F83F6164C28452F053B466261766AE4"
    "FA9C3B45531134BFCAC3E6F26E34EB8106F08C1CE7100B4AB57B6BC597B2DC35"
    "00DE9E7849E9C5F0BD32CAFE20D3F57D83B13A252A3E190A92710C29DBD48E86"
    "3FDFBCEAF4656E048CCA6832FC8867AE9209DFD571B3886D82D5FC19652FBA12"
    "35D48BFE1F5B1E0DB61ACB91872C81BC56266C02A98CD7DE70E57F3BF4892A74"
    "0EF3E99D24FDFDAEB653E0541479B5EAFEFF9C2FD7D5A61938D9A4AF56444D0F"
    "84C9185D7C9B23D0F96A50FFFBD491A550FCA2CCFCCE5ECE6A02CC5CB2661634"
    "FF4E08989AE7E75E6BA05B6A92D89E3ED7830C3D08B277B6494F6C2EC807D573"
    "1B973E0AECDD6C98736C226918D64374827AD3CCC6F170A76CC70B05B3BB5C06"
    "32A9BEDBA383EBB034DC8726284D9ACFF9D468350AB7B9FB5AB8CFE49D240DAC"
    "4FF2E971EE3B40AC3131055C29B35FEDAF567C3D4823E238AB3EC5602C27FC7C"
    "8BA6454AC72F713C1E10E47696EB104CB38C32B1BD15DC746ECE463245F1C754"
    "D0CC490F03CA647D6841421B879FAA1D2CD0EDEB5B811606049F83E6A54CA29F"
    "A68E987DC76E21FBB130AF53CB1E81F6B33C3F236040D544B13DABC6A6282DB3"
    "BFC8127258F8714ACE8B22D3D19C5039B2B6F380D6D0907534096924C6446A77"
    "1CCA6997DB2695B25F1469EEA7620CAC7304B272BA784C9FCAD29A5168D8EAAD"
    "603507DC0A9C77077D8D60AF7CF96AD78EAC512CDAA74630FB9A2CE9C59ECE85"
    "D92E8EC0E45B3D0E2379EA4F0A9148579745B11939E497DFA8B326FEF9AA4E63"
    "11CDB033A1E5AC84803B3FB397C4A72890CAC2717D6309771C137E60A1E07D29"
    "6840401CF55877FB2D6147BA60226AFEAC149E1E31A69BAF8CA114634680A741"
    "DF29A8A13FC3655A745D07A79DAB9FC4DAE7308175BF217A7C304F4CD8139D55"
    "0ECEB8FC18957222141F7A2E4BF3015FBF07A6D87DCABA68F24DC9792CE36226"
    "D095706AA728964140C24EDFD85FE9164075D015D566FBF2CA8464F5689E815F"
    "BDD22AB0758ED9AA5B34B40395E2A6B3097A808E9F28BDD6FACE3F87F1EFFFAD"
    "42898D8EA1B74CDDDD2D34BBD211180DD541B9501793978D66AD3AB3D7B6AAE1"
    "6E43C220A99CF41336F1956C74BE21F86778577B355D426C25D4739F84399FEA"
    "22E4F56326BAAEB08E3EE32915AE24894483AC9B252BE5544FECF11DC3E746DF"
    "5EF35B43CCD81498F9F6BEDDD62531CCC29641698F72E7AA5ECF63C239187BFF"
    "F798A8523BCD2EAD03C486C94280B5E7E322925F69EB9B867F42C1239C9D6F5B"
    "9D9F4D0F8F87DFEDBEF48E03EAC17A23F976FBEB76638FD6A68AE7E4D7DE1D9C"
    "4AC5249E204AB7D60F02ACB2710D6A993F4A65D01C653A90EFA290740F257A40"
    "CF1E95F4A5EAF60BDD90E65EA9838D89B383AD94EE5B6A966507D80CA9920291"
    "CDB286CE36F3285F79A7804EBDE1D3058E3CBCB485F4A016E1CCC6BC0BA126A1"
    "BDC80134741D26FC6BA3DF72350437E1804B1DF404566FF1C7C5587950A8833A"
    "B5CA0DFE2A639ED02CCDC7E25FCA9F1A3B3ACB66EB25AE31A6E4B126BD043B20"
    "D02A7A85756B31D0751550D18E65C67AD43B8375F895365AB87FAAFFE244EE2F"
    "909D47613BFA3D9696DCF1EFAC32427B99ECA020480BB6E207BDDC108052FCCC"
    "8C815B73296B51B3D3A1848CFC0E1F64D012740291AB93B0FF624A58E557D4B6"
    "6AA28BA874C15A33A07A1ECFF6AAD72693735D905B38AE1D945718371F8A4963"
    "36162CC26D2975933A56BCFE8D6751CF81815AB47F4F5EB7689C65ECAA40EF68"
    "58074FBF2F6EA854FD03E32EB7D47D0D1B024534EECC166890E6C26AB24F4545"
    "BF9EF7BAC3E431AEBBFB42E5F1E941AA08D2178531F1334F4C30165E1460F7E4"
    "5EC16B04EC4DDA388BCDAD47D0F1C88AE49C1E97E0E709A7CBC7E71FE9C60F01"
    "629644B803F3B4E3FE2E2EBE53FCC9BACF146FEF23D71FC89590E8B3370CD0BD"
    "F75EAB4058F300574E960AFF27121AF82D2F4262F13490F30FC5308F5DC9FDF3"
    "F88B52DE8B1F503E4B56548DED307CD93A73B666E09D24B04A1DC24B8EB7287C"
    "3DFC23E19406E727D196B7DC053A7FBBB14D073E922F45F2311ACB6D9E4D1ACB"
    "3DA2186A41BAAA0940845047E91B9E31468A1AD549C0576913DFE834DFEA891A"
    "556993A079B14C129C1B273BDF27DAD2857D906C8AE2ABCCB967F55932C3FC38"
    "0A1E1784811D0C8CADFCD621B16E24BA0E84AC5F099A5E77B0C6C191F6EEE50F"
    "66841729898C84E9DF25D985B748D8199E303E9E36829CAEF0ADE11B624E725A"
    "CC034CD7ECEACA81BDC208BEB05B785F2B35D4FBDBC62F7E48558887CB45ADD3"
    "9F18C609037EFFF392AAC7388763BBAB565EF73A608E3E862DE246168DA7089F"
    "4808E3CF4A4694711F554DF12C885EE028470F9C8A9E1943B3D10002AF631C8A"
    "AC815E046D8B73822EDDC2F3DAAAE89A479FCECD946D0DB9CEFEED3C0358E984"
    "12EE91C48A9414BC58BF1DAB4BEAB35B2F13ABDD35AB3BC3DB60A42C3483412B"
    "6865C5D7AEFEDB79B12BE4DCD70370E7EBAB739168299670A3CF4E2E9BE2EECC"
    "864F473FD7214676F416CBEA52E743F9C435B191BA27330919058F3B27796F6D"
    "4BDD9E4188E2FF134EE9972E0B47C614D2C1F5CF3326BA428EA3E15A141957235"
    "300D67389385F3BEA45454EE2332E5A1FA021DFD5ED6824D1DF0FBE94A6F4AEA"
    "BB197263875704B891F20B1AC47A1D2F598A769E754A865BAFAC8530A726FCA1"
    "E0FFF4726DF280A9549BDF7B59C032B5E70FF0F0B05A0789CE6A6039C5562637"
    "EBD8C2E6EEC26BFD4FA599287280BF26E68487E7E103EB5F9B97FA390943774D"
    "C9F73328E50947471976B26EA7875CA42A672C976C575319725DD41E205466EA9"
    "4F227FA77242C6866122F650B6ADD3C75E2CC8EA314F3874E3A311059550E6BD"
    "1BABE2F4FD4C5FF9E0930C910E8488C821F8BE09C2CE7278996D31A708F44D03"
    "D141999B30E99CCA6B91264EA257C5ED581E7A92925B5EB477E0C7BBF429B9DE"
    "20EB7FBA0A6C258CEA8B3A1C4AA7B8124C6ADF192C0EFA67084FCFBE9D26D309"
    "C52DA45218E8637355065C605E3F688A1DCCFAA7F5179FE650A8B002A5BB8625"
    "78E538F60925C87A8AB68A0780A71EB90A0E7BE9916982C827EE38364BE2E11F"
    "AA771060DA5514CFB11E175967016EA79953830960F9A59F132CAC4CBF7211FE2"
    "16E8CB4E1C4D5C2DD8190E4E8B7EDDB49AE79D67CF11E47B2243E60C2BD6F61"
    "4E5F92B625E941E8BB73719056A377D9D4C3063214B42D74ACE8502156A0562E"
    "6A011BE9427DB957654F04D25800466D6DF157157D3ED07D8F8CFC8375D742DB"
    "0B2ED0CB3383E2F7ADEC648F59A0B52F3C32673A2A164479D8B2E151535B3F4C"
    "34BA4078D5A4713580B103E1F5DA08463EE9A727B8E9240CEB96FC12699F0065"
    "D60C896BF9CA13478313413C94BF3E2FF46E78A00D6CC80A47290E0F35B0CCE7"
    "80E27FAEA8231E10AB52F2E749A381E6CB5381AE43CB564D05C953B1581A4E7D"
    "2D16BEBB3BCDDE7CFA85FDE822EA011479D110DF54044886D1668F0035FA3CC9"
    "06626505814D96DFE0DE6CB0F8EEBFAA720918270E55B6ADE2BDF155082EE437"
    "54B97F1FED36421691CF29A2E717055879AF86FE7E633EC0742E958B23B3FECF"
    "5E2BD110F73834AA3B9CD9379F0503B435DD67DE9A253616593408AF5A492C40"
    "A97025C76A006877DC5CC3E98BC4323A45C0F96786ADD841BA823FEE1A989B2E"
    "0A329954DC07542992D5B8747B424C94965833B89E795A108EC3BC04D6CEB180"
    "4F2B22ABE89157758F0AC3EC41526E9D0D19AFF285C7C33BDB105C7A1FE6F225"
    "8CB43F6A7CFCA44EC3AB654E3FD6F69269B782D517C3700F9CEA95C95DD0E17E"
    "77302871B4F212AF750655F019F85249FCAC5D0EDA33651FBC839B6CE4D43B62"
    "AA2AC33ABB9B74F95F65002E4AC8047AF5EDA3DC5463832F84B328CFDE01AD4C"
    "A0FD17C6263975D36490F3D51D93C97AD9B7AF04BB426DADA3206C67B2575EF3"
    "18CCE00D89B51654FAD2463CED2F73C3DBA5BD11CA84068ED37181982765DCF2"
    "5C7A3E674859C28601E0A0C10AFA98BB1CAB2C6834694AED72F276054CEDCE16"
    "F313D0571218D472912071D5B8BAA723D4C5A65A1A2B2C0FA2F385B66868993A"
    "1C11C22323B4F698F949EB4D39DC4FB0627282C496A82891757A2C3C7D9EEF1F"
    "300000000000009121D202831"
)

# SLH-DSA-SHAKE-128s keygen vectors (ACVP-Server SLH-DSA-keyGen-FIPS205, tgId=2)
_SLH_DSA_KEYGEN_VECTORS = [
    {
        "tcId": 11,
        "skSeed": "C151951F3811029239B74ADD24C506AF",
        "skPrf":  "DD30363E156E6FE936EC6ED0231FEB5C",
        "pkSeed": "529FFE86200D1F32C2B60D0CD909F190",
        "sk": ("C151951F3811029239B74ADD24C506AF"
               "DD30363E156E6FE936EC6ED0231FEB5C"
               "529FFE86200D1F32C2B60D0CD909F190"
               "0761F9B727AFA724B47223016BB5B2BA"),
        "pk": ("529FFE86200D1F32C2B60D0CD909F190"
               "0761F9B727AFA724B47223016BB5B2BA"),
    },
    {
        "tcId": 12,
        "skSeed": "D3ADF41FF57EED108BEF2D8733F4C2B0",
        "skPrf":  "09A00EF4596B23E1FFD5136C135A713A",
        "pkSeed": "B64302C8D20FB89AA2414307D44E1F9C",
        "sk": ("D3ADF41FF57EED108BEF2D8733F4C2B0"
               "09A00EF4596B23E1FFD5136C135A713A"
               "B64302C8D20FB89AA2414307D44E1F9C"
               "6EFA39EBBA94B0633C900644B81DE2B9"),
        "pk": ("B64302C8D20FB89AA2414307D44E1F9C"
               "6EFA39EBBA94B0633C900644B81DE2B9"),
    },
]

# SLH-DSA-SHAKE-128s sigGen vector (ACVP-Server SLH-DSA-sigGen-FIPS205, tgId=25, tcId=214, deterministic)
_SLH_DSA_SIGGEN_SK_214 = (
    "8BE78EF32C6EEB19E88EA1ABFD1A518C"
    "1C3B7F755CEBB3BFFBFC95B45D6A4685"
    "2D28F61B5F890E74B86F7B18DC8FC59B"
    "7EA6F3763850C2025BCCAC79DD6F3457"
)
_SLH_DSA_SIGGEN_CTX_214 = (
    "4BBD539EF8E37E9816D1251C59C1364E"
    "D5EC02089406E4628DA1BAD4075EF341"
    "98AE483331A67A438DB799666321377B"
    "05B2B90C6DD7CA93F1844572260C4FB0"
    "37893E903C3C008EF96FE05F9AD5E6D2"
    "14E1E0570E2ACAD63F856F313573B36D"
)
_SLH_DSA_SIGGEN_MSG_214 = (
    "16333C4AF44B5CE609C83737AE0A1961B57AE6DA7A66E474D332DC99220A5730"
    "A78F69B3379C4DFABB5ABDF29E9D091C1E923B8CA45BFD80E773E642461741C7"
    "BBD6D5B72637F3F1078A3577E7CBE7B97523B163D112077D468FEB2B8E5585F0"
    "D2A5BE86577E3FCFF50D9FABD84310D29F7498CB08136C795D2C366507E9FFA7"
    "360DBBF79D862E0DEFB9763E8B64A97DF5F2158DFCBBFE8D9D5B0D858C2E896C"
    "4C2A1081C105C4B402958706A109D46BB1C29391564BD1478F7CFD623A30A277"
    "C0184860CF5B3F89846BD9CE038D0A9ABE48B52EA54A84948AE0DC008F481FDB"
    "638B94ABA493B367F139DBDBE05C276C7D8CAB5A0C060255C3EDF383C230C25F"
    "47B92B2BFA872769A3C235A79F48817E649F3152A867958FB68E32CCFC572A26"
    "E07B2362DB8B0CAFDF53C2A296B8E3F5B9F0DAEC57A3DA6B1C06B7063606BD65"
    "65CB5F823E3B6E3E8C89F583D2B2966D9469D3BABC8FF240FD619D49CA9838D4"
    "D795542C25785F8CAA977C4AE4D8CDB950819E6FDB94FBB9F885FA9DC718D608"
    "D4D95BA06BE6EE33D8AE4FB849EAC5F8FF6462A1A10DAE3335C01314AB383BF9"
    "4FC535AAD1CC1EB322407C8AC8307A0B99A6D5031226CE09842D6D899A1174553"
    "917E9C3F65F9FD46875C76F173360A34AAD261F8D751038882B0970A18628E9B"
    "093BD28D4C4B8BFC66278225E57358D9E0E10C2FB24E9F73FBD87AE1F6637E09"
    "825C64CC1FEB15A702144766C4FF610DA29D7D966C00F77E07E26861E29E10BD"
    "9E572546710B775E776830B9BC9766643A6D7017111C50A7A2E5C787399D0F32"
    "DE040E3B539B6B22B48EA2CCB8AA53DF79A20EF1C0FEB19C8288E1EC2E2BED2A"
    "34E9641066E006395F4105C2B8E33094C1F5B326C7442C3214651B69C4CA73BA"
    "515BAFE93F25C52CC8C635FD20C601ADF2A6A6A1E64E75E4D2A3363C0CDEFF85"
    "3E3698BA81234B789799653D28FED55AA12838C44FA1F0FA16311C7A9E6CC63DF"
    "35EEC0610B2C62B7AF643D7388C15EF2DD498D30CF2E42A3CB96D575EB66EEB7"
    "0ADC93EEDF32F4A0B45B723DC2DB383886B310D5836DBCC9DDA094FFCC171321"
    "A2004FC1FAE5A5ED1F119D8CF71F445F96A18CFE8790B7599D8ED4842013B152"
    "E7695D073ACEDA13B198653BC75A57B125B4127E69FB8BFF07898FD4F9568584"
    "4D64E64ED16914A920F5F91390BFE32D62CDDBA598FEB6CEB82F704F77FA09AB"
    "ABF6FAAA87BA7F015AAB7D20C9442E77D907CE0202317A470F6D08516A6E549D"
    "15C257BE36BC3431D0DDD71346C63BC180DABECC971F6E03B43167BCEB50DE31"
    "BEC3E60505AF5297D3662270342F797629F4A249A01261FCC85D6E89530898F24"
    "E0B42BF3C65B623235EDEF81B366123BABAC483432D3D0183236ABBD376F5B25"
    "F3DA695533331EE78E676DE13E41F331941FF49BAF730F4A196F36E532E099A3C"
    "F2DD3A697A64B9047F7B7421DF977791BEEADC1032A43C780F10B8ED366DF35A"
    "97BDAA5BB1F1041E0F7C5F33A904B24EE0A4C1226431FA9D38EC5B7E83C981DE"
    "AE1D2591E65736800D40422C4175646A8E3BB6B74BA277BD4E91B3E772115F52"
    "A9A1A80D6E418A975C0DC5DBEF482EECD3CD90E21B2B7F572A94D270EF928DD2"
    "1C3175706137381E1ED2E3CBF9A2512101A379FFE37B831F110945A65FA86A3FD"
    "8BF7D406A2F8F4DCC735E9E4A9161703B32185AD265919A71E09FF08404927C7"
    "12D5C5B128C5319FD4C657516F5FFB1FACAABF225DC6C351A90CDBD498C9931E"
    "9749449425B3AE6253D363F9BAB2A3E9EE97C1E367CF105779EB64C737957338"
    "B002141339D9A77E8E16F16E1E4D3D0DC4037A1BF24320AB5C8E7DCD222C8945"
    "417236F7C077FD58A3C426887A7CD5E7A896F3C0DAB4AAE6F9E48B37224B32B4"
    "AF6BDAF424E5A4C7C444C0AD3A1A8FE7B5900864E138B11C665BDD654FC19D74"
    "6160A30A549B77B10BD4F98BD11132D749DAF8CFBFA41542663F8F9CA6A09CCD"
    "D0A1CE7CE1D9B2BE5FC818F68B274BF5E88415DC8F7E163FDD94E41749D78924"
    "CB74A31D072B5B6FB7883DD5D3F2E74A46C9642FC5683283BEC5A84D496A369D"
    "9DFCE9626192BF5CA3EB44C1F1C4F575D22D8170651711B4E714AFC687FF4AFC"
    "4A3FAAD968B967D849D946E72D19A86E9C204C846670CD38D6522BD96AF935EA"
    "C261EBAA3391A61EA1F7F1325FF80702FE1ACFBDEA1D6E25D9DE7B1ED819C03B"
    "0B96EF242C96795BEE2691D4A6A7174160F3F33B343181A1960830BCFD944533"
    "CC97D9674977F6E145F3FF7BBF043E1A8B68A31D5D9CC2E50E289C1387CF5FDD"
    "9250D8D4B1A2BA040140C7F7169FDA322BC87C4D61D794A56C9B1A038C08321D"
    "FB060B893659D307B614F4E2323F70182C282BB9DD4AE39DEA0F2E94AA6028F6"
    "230A3686B7F65A4772598845757EA49B2FB463A50E5518219CB38F80A155514E6"
    "A6A50E6CA9FDC9FCD2A1EE56C7051699FCFF9FBAE836083E0F12684961761914"
    "EF4C5D6D8446B19B012286EE8F912B33815A802F690332031392B35B98CA1E59"
    "8F7EE8F33998F47D2E09BE1A3A1BD1C26D011380D0A992D740960678C4DFA5BF"
    "3DC0096154993495DB51D8FCDB739A190B773B3D8A5C1A98DF3D8D6E2ECFCE06"
    "06998ED434DD3AA83E9EDCEA417215CD04344892E6AB59CB953D3E8F427334B83"
    "B1A6FF0409E4D540A21E9E327AFD61ECCCFE162870921768ACE72813144CA288"
    "204991891E29DE696D09C0721E39A08BF70D30D9CB6BCD43200D3DE84E425A72"
    "90BC7C2B7958EA0DD7E1844DE53765DADF76657EBF43349C650AD1F827A64AF1"
    "57B5B9841470025C7BF01D0008325E0205658E9933A2285A4090AB7BA555FDE4"
    "E18C8033397B305E1F9910D79D753D0086875E259B2C7DD7E8F30F54DE11E59C"
    "C7BA853542D489638B19C5B18A014D4FF5799D9AF2C5AF66C1C317C2DECB77D5"
    "4AAAE8EAC5228A142240EB3A834FAB00B5DE2055F73037A0A54A67DCF8ABA476"
    "5458F12502031E15CF84DB2A7644A12990107E7341DC2E4BCFEAEDE34859A8FD"
    "6B618F34794B1124516222158C079B932DB026A1A91FE7D38D7A7023377F87F1"
    "AA672211D7CEE9C6B2179329AFBBB6400E1552C04B53649D7357035301D34BE4"
    "8BC1D14247A9A8707061F50DAD5B3A80CD71F6736403C37BA969CB804F6A28B7"
    "254074DA3C83B20498B6D40ECF0DF74EE752BD3A8A712500AC0DD5F9BE413754"
    "70C41BA4AA11D38AAC70F499046F897F6379D186BEA97B40E51EFC100E6E759D"
    "4FE87E488D6AB8B8D96BD405C21A2FA82DE46823DE873CEF1CA91F52DABCF680"
    "76B6B33407A763CBADB01DEB8887F9F471C6CCF4EEFC43F31C85FFE1365668E7"
    "575C8DBC1E916EEAE95720228A49650C9A45A933A44DED0462C1C576924D12CD"
    "D29824ED94844A2B0A7142CBF0A6C4D1FC823E59144B8F7C4A223068BC696C2C"
    "1320D95F2B519EC89ECD8F23BA2726933A81DFFE6935EEBBE7404F234CE8E889"
    "A4FCF32749FF63DC80978F02F776CC99458D41A4F301291648234E8F3E1F602D"
    "D076AA86C07C207C36D30F824C36DF35DF8D32BD06B9004F83B3A37A7B9AAF80"
    "29DB39C6AC9C16883A586DF350ACC9EB9DCA29DD9F8A090A4D4722D7046AC4A4"
    "C6502F16226D0FF95AD2371FC34D96A68AA7D5403F65E048F16C33AC95716A71"
    "683130E7435493630A69438FD2FA6670F3B8486EDC3CD60737627AB5D00A52AE"
    "520A0A39CE9A5ED306A17D156D17BB6C1203B6F81FCC8B726B0F719237AA1487"
    "7EB0978E668884BAA0582B57AF4106B904A25FE481D15EF99860B243450F3B31"
    "F92C6673D0C00E71E848C96EC613E32D42B6A162DC0DA3D524785E64FA6CF379"
    "C6F17B827E497FA6053BF235B67361E6D5BCB03878F22364AED4BD406613ADDA"
    "7E7FE2380AB8D9F2FF1A650F7252B9E1B8B488984761F9A929764B584C6EC07A"
    "4B748860652AAB5E5507AA62AB5CEAEA2D09BF368DE94EF6E04752B6172EFAA9"
    "8D105C6D4CD6FB67EB16819668D9F07C2C528747184D8A97D1C54750929674D6"
    "9E134CABC9174CA450C774088120CC2797E54C8C0598BCC9BC2574898B4C2F6F"
    "2F02C72501986178EE8CEFD50736CD565ED29CC1F593E955484E343A903B31309"
    "C7B4F4E771AFA34A7421FEEFDF507E06004C4BC7CCBEA6E513E400BCD18BB0E6"
    "BDDDA0F172D6B139F198DDFF23A938849F1435B39AD1E668A667BE22E994E352"
    "21229918D41E1A35FFE699B2274C4CD206E951B4DED10857F575108D0CB11F8A"
    "4B054C707C3E6DF0C81385A229DBDEB6F4CAD3081F2E576D921557410FE34985"
    "88C28E0502419CDAF170E2353F9B6D4CB71F705536A84DD90A4FB118195E61AB"
    "49C43E962795D5652009B06C0861BC442E70A0708F9249C758B69AD8A6BDE4A1"
    "DDEB97FCDF9BBC578FFFE87F6FA68FA42757D6FE003E96E0C01D32E4EC656508"
    "891F129806E49C046EA0AF26730AE58A9A873D0BC66EC1F0839EE07BA02BF83F"
    "265C8A54302A2C64639C6CC22F1A7FA199D210E5A48B65147443C33248FFA0DA"
    "63DE40F2AB"
)

# SLH-DSA signature for tcId 214 stored in separate file to keep this module readable.
# The test will skip if the file is missing.
_SLH_DSA_SIGGEN_SIG_214_FILE = os.path.join(
    os.path.dirname(__file__), "vectors", "slh_dsa_siggen_214_sig.hex"
)


def _h(hex_str):
    """Convert hex string to bytes."""
    return bytes.fromhex(hex_str.replace(" ", "").replace("\n", ""))


# ── ML-DSA-65 Tests ────────────────────────────────────────────────

class TestMLDSA65(unittest.TestCase):
    """Tests for ML-DSA-65 (Dilithium) FIPS 204."""

    @classmethod
    def setUpClass(cls):
        from crypto.ml_dsa import (
            ml_keygen, ml_sign, ml_verify, _ntt, _inv_ntt,
            _PK_SIZE, _SK_SIZE, _SIG_SIZE, _Q, _N,
        )
        cls.ml_keygen = staticmethod(ml_keygen)
        cls.ml_sign = staticmethod(ml_sign)
        cls.ml_verify = staticmethod(ml_verify)
        cls._ntt = staticmethod(_ntt)
        cls._inv_ntt = staticmethod(_inv_ntt)
        cls._PK_SIZE = _PK_SIZE
        cls._SK_SIZE = _SK_SIZE
        cls._SIG_SIZE = _SIG_SIZE
        cls._Q = _Q
        cls._N = _N
        # Generate a key pair for reuse
        cls.seed = bytes.fromhex(
            "a0b1c2d3e4f56789a0b1c2d3e4f56789a0b1c2d3e4f56789a0b1c2d3e4f56789"
        )
        cls.sk, cls.pk = ml_keygen(cls.seed)

    def test_ntt_roundtrip(self):
        """Forward NTT followed by inverse NTT recovers original polynomial."""
        poly = [i * 37 % self._Q for i in range(self._N)]
        result = self._inv_ntt(self._ntt(poly))
        self.assertEqual(result, poly)

    def test_ntt_zero(self):
        """NTT of zero polynomial is zero."""
        zero = [0] * self._N
        self.assertEqual(self._ntt(zero), zero)
        self.assertEqual(self._inv_ntt(zero), zero)

    def test_keygen_deterministic(self):
        """Same seed always produces the same keypair."""
        sk2, pk2 = self.ml_keygen(self.seed)
        self.assertEqual(self.sk, sk2)
        self.assertEqual(self.pk, pk2)

    def test_key_sizes(self):
        """Key and signature sizes match FIPS 204 ML-DSA-65 spec."""
        self.assertEqual(len(self.sk), self._SK_SIZE)
        self.assertEqual(len(self.pk), self._PK_SIZE)
        self.assertEqual(self._SK_SIZE, 4032)
        self.assertEqual(self._PK_SIZE, 1952)
        self.assertEqual(self._SIG_SIZE, 3309)

    def test_sign_verify_roundtrip(self):
        """Sign then verify succeeds for valid message."""
        msg = b"test message for ML-DSA-65"
        sig = self.ml_sign(msg, self.sk)
        self.assertEqual(len(sig), self._SIG_SIZE)
        self.assertTrue(self.ml_verify(msg, sig, self.pk))

    def test_sign_deterministic(self):
        """Same message and key produce the same signature."""
        msg = b"deterministic signing test"
        sig1 = self.ml_sign(msg, self.sk, deterministic=True)
        sig2 = self.ml_sign(msg, self.sk, deterministic=True)
        self.assertEqual(sig1, sig2)

    def test_sign_empty_message(self):
        """Signing an empty message works."""
        sig = self.ml_sign(b"", self.sk)
        self.assertTrue(self.ml_verify(b"", sig, self.pk))

    def test_sign_large_message(self):
        """Signing a large message works."""
        msg = os.urandom(10000)
        sig = self.ml_sign(msg, self.sk)
        self.assertTrue(self.ml_verify(msg, sig, self.pk))

    def test_verify_wrong_message(self):
        """Verification fails for tampered message."""
        msg = b"original message"
        sig = self.ml_sign(msg, self.sk)
        self.assertFalse(self.ml_verify(b"tampered message", sig, self.pk))

    def test_verify_wrong_key(self):
        """Verification fails with a different public key."""
        msg = b"test message"
        sig = self.ml_sign(msg, self.sk)
        _, pk2 = self.ml_keygen(os.urandom(32))
        self.assertFalse(self.ml_verify(msg, sig, pk2))

    def test_verify_corrupted_signature(self):
        """Verification fails for bit-flipped signature."""
        msg = b"test message"
        sig = self.ml_sign(msg, self.sk)
        bad_sig = bytearray(sig)
        bad_sig[len(sig) // 2] ^= 0xFF
        self.assertFalse(self.ml_verify(msg, bytes(bad_sig), self.pk))

    def test_verify_wrong_sig_length(self):
        """Verification fails for truncated or extended signature."""
        msg = b"test message"
        sig = self.ml_sign(msg, self.sk)
        self.assertFalse(self.ml_verify(msg, sig[:-1], self.pk))
        self.assertFalse(self.ml_verify(msg, sig + b"\x00", self.pk))

    def test_verify_wrong_pk_length(self):
        """Verification fails for wrong public key length."""
        msg = b"test"
        sig = self.ml_sign(msg, self.sk)
        self.assertFalse(self.ml_verify(msg, sig, self.pk[:-1]))
        self.assertFalse(self.ml_verify(msg, sig, self.pk + b"\x00"))

    def test_different_seeds_different_keys(self):
        """Different seeds produce different keypairs."""
        sk2, pk2 = self.ml_keygen(os.urandom(32))
        self.assertNotEqual(self.pk, pk2)
        self.assertNotEqual(self.sk, sk2)

    def test_keygen_wrong_seed_length(self):
        """KeyGen rejects wrong seed length."""
        with self.assertRaises(ValueError):
            self.ml_keygen(b"\x00" * 16)
        with self.assertRaises(ValueError):
            self.ml_keygen(b"\x00" * 64)

    def test_sign_wrong_sk_length(self):
        """Sign rejects wrong secret key length."""
        with self.assertRaises(ValueError):
            self.ml_sign(b"test", b"\x00" * 100)

    def test_context_binding(self):
        """Context string binds the signature."""
        msg = b"context test message"
        sig_ctx = self.ml_sign(msg, self.sk, ctx=b"test-context")
        self.assertTrue(self.ml_verify(msg, sig_ctx, self.pk, ctx=b"test-context"))
        self.assertFalse(self.ml_verify(msg, sig_ctx, self.pk, ctx=b"wrong"))
        self.assertFalse(self.ml_verify(msg, sig_ctx, self.pk))

    # ── NIST ACVP KeyGen KAT ─────────────────────────────────────

    def test_acvp_keygen_tcId26(self):
        """ACVP ML-DSA-65 keyGen tcId=26: seed -> pk matches expected."""
        seed = _h(_ML_DSA_KEYGEN_SEED_26)
        expected_pk = _h(_ML_DSA_KEYGEN_PK_26)
        sk, pk = self.ml_keygen(seed)
        self.assertEqual(len(sk), 4032, "sk size mismatch")
        self.assertEqual(pk, expected_pk, "pk mismatch vs ACVP tcId=26")

    # ── NIST ACVP SigGen KAT ─────────────────────────────────────

    def test_acvp_siggen_tcId31(self):
        """ACVP ML-DSA-65 sigGen tcId=31: deterministic sign matches expected."""
        sk = _h(_ML_DSA_SIGGEN_SK_31)
        msg = _h(_ML_DSA_SIGGEN_MSG_31)
        ctx = _h(_ML_DSA_SIGGEN_CTX_31)
        expected_sig = _h(_ML_DSA_SIGGEN_SIG_31)
        sig = self.ml_sign(msg, sk, ctx=ctx, deterministic=True)
        self.assertEqual(len(sig), 3309, "sig size mismatch")
        self.assertEqual(sig, expected_sig, "sig mismatch vs ACVP tcId=31")


# ── SLH-DSA-SHAKE-128s Tests ──────────────────────────────────────

class TestSLHDSA128s(unittest.TestCase):
    """Tests for SLH-DSA-SHAKE-128s (SPHINCS+) FIPS 205."""

    @classmethod
    def setUpClass(cls):
        from crypto.slh_dsa import (
            slh_keygen, slh_sign, slh_verify,
            _PK_SIZE, _SK_SIZE, _SIG_SIZE,
        )
        cls.slh_keygen = staticmethod(slh_keygen)
        cls.slh_sign = staticmethod(slh_sign)
        cls.slh_verify = staticmethod(slh_verify)
        cls._PK_SIZE = _PK_SIZE
        cls._SK_SIZE = _SK_SIZE
        cls._SIG_SIZE = _SIG_SIZE
        # Generate a key pair for reuse (keygen is expensive)
        cls.seed = bytes.fromhex(
            "a0b1c2d3e4f56789a0b1c2d3e4f56789"
            "b0c1d2e3f4a56789b0c1d2e3f4a56789"
            "c0d1e2f3a4b56789c0d1e2f3a4b56789"
        )
        cls.sk, cls.pk = slh_keygen(cls.seed)

    def test_keygen_deterministic(self):
        """Same seed always produces the same keypair."""
        sk2, pk2 = self.slh_keygen(self.seed)
        self.assertEqual(self.sk, sk2)
        self.assertEqual(self.pk, pk2)

    def test_key_sizes(self):
        """Key and signature sizes match FIPS 205 spec."""
        self.assertEqual(len(self.sk), self._SK_SIZE)
        self.assertEqual(len(self.pk), self._PK_SIZE)
        self.assertEqual(self._SK_SIZE, 64)
        self.assertEqual(self._PK_SIZE, 32)
        self.assertEqual(self._SIG_SIZE, 7856)

    def test_sign_verify_roundtrip(self):
        """Sign then verify succeeds for valid message."""
        msg = b"test message for SLH-DSA"
        sig = self.slh_sign(msg, self.sk)
        self.assertEqual(len(sig), self._SIG_SIZE)
        self.assertTrue(self.slh_verify(msg, sig, self.pk))

    def test_sign_deterministic(self):
        """Same message and key produce the same signature."""
        msg = b"deterministic signing test"
        sig1 = self.slh_sign(msg, self.sk, deterministic=True)
        sig2 = self.slh_sign(msg, self.sk, deterministic=True)
        self.assertEqual(sig1, sig2)

    def test_verify_wrong_message(self):
        """Verification fails for tampered message."""
        msg = b"original"
        sig = self.slh_sign(msg, self.sk)
        self.assertFalse(self.slh_verify(b"tampered", sig, self.pk))

    def test_verify_wrong_key(self):
        """Verification fails with a different public key."""
        msg = b"test"
        sig = self.slh_sign(msg, self.sk)
        _, pk2 = self.slh_keygen(os.urandom(48))
        self.assertFalse(self.slh_verify(msg, sig, pk2))

    def test_verify_corrupted_signature(self):
        """Verification fails for bit-flipped signature."""
        msg = b"test"
        sig = self.slh_sign(msg, self.sk)
        bad_sig = bytearray(sig)
        bad_sig[100] ^= 0xFF
        self.assertFalse(self.slh_verify(msg, bytes(bad_sig), self.pk))

    def test_verify_wrong_lengths(self):
        """Verification fails for wrong-length inputs."""
        msg = b"test"
        sig = self.slh_sign(msg, self.sk)
        self.assertFalse(self.slh_verify(msg, sig[:-1], self.pk))
        self.assertFalse(self.slh_verify(msg, sig, self.pk[:-1]))

    def test_keygen_wrong_seed_length(self):
        """KeyGen rejects wrong seed length."""
        with self.assertRaises(ValueError):
            self.slh_keygen(b"\x00" * 32)

    def test_different_seeds_different_keys(self):
        """Different seeds produce different keypairs."""
        sk2, pk2 = self.slh_keygen(os.urandom(48))
        self.assertNotEqual(self.pk, pk2)

    def test_context_binding(self):
        """Context string binds the signature."""
        msg = b"context test message"
        sig_ctx = self.slh_sign(msg, self.sk, ctx=b"test-ctx")
        self.assertTrue(self.slh_verify(msg, sig_ctx, self.pk, ctx=b"test-ctx"))
        self.assertFalse(self.slh_verify(msg, sig_ctx, self.pk, ctx=b"wrong"))
        self.assertFalse(self.slh_verify(msg, sig_ctx, self.pk))

    # ── NIST ACVP KeyGen KATs ────────────────────────────────────

    def test_acvp_keygen_tcId11(self):
        """ACVP SLH-DSA-SHAKE-128s keyGen tcId=11: seed -> (sk, pk) match."""
        vec = _SLH_DSA_KEYGEN_VECTORS[0]
        seed = _h(vec["skSeed"] + vec["skPrf"] + vec["pkSeed"])
        sk, pk = self.slh_keygen(seed)
        self.assertEqual(sk, _h(vec["sk"]), "sk mismatch vs ACVP tcId=11")
        self.assertEqual(pk, _h(vec["pk"]), "pk mismatch vs ACVP tcId=11")

    def test_acvp_keygen_tcId12(self):
        """ACVP SLH-DSA-SHAKE-128s keyGen tcId=12: seed -> (sk, pk) match."""
        vec = _SLH_DSA_KEYGEN_VECTORS[1]
        seed = _h(vec["skSeed"] + vec["skPrf"] + vec["pkSeed"])
        sk, pk = self.slh_keygen(seed)
        self.assertEqual(sk, _h(vec["sk"]), "sk mismatch vs ACVP tcId=12")
        self.assertEqual(pk, _h(vec["pk"]), "pk mismatch vs ACVP tcId=12")

    # ── NIST ACVP SigGen KAT ────────────────────────────────────

    def test_acvp_siggen_tcId214(self):
        """ACVP SLH-DSA-SHAKE-128s sigGen tcId=214: deterministic sign matches."""
        if not os.path.exists(_SLH_DSA_SIGGEN_SIG_214_FILE):
            self.skipTest("SLH-DSA sigGen signature vector file not found")
        with open(_SLH_DSA_SIGGEN_SIG_214_FILE) as f:
            expected_sig = _h(f.read().strip())
        sk = _h(_SLH_DSA_SIGGEN_SK_214)
        msg = _h(_SLH_DSA_SIGGEN_MSG_214)
        ctx = _h(_SLH_DSA_SIGGEN_CTX_214)
        sig = self.slh_sign(msg, sk, ctx=ctx, deterministic=True)
        self.assertEqual(len(sig), 7856, "sig size mismatch")
        self.assertEqual(sig, expected_sig, "sig mismatch vs ACVP tcId=214")


# ── Quantum Seed Derivation Tests ─────────────────────────────────

class TestQuantumSeedDerivation(unittest.TestCase):
    """Tests for get_quantum_seed() and generate_quantum_keypair() in seed.py."""

    @classmethod
    def setUpClass(cls):
        import seed
        cls.get_quantum_seed = staticmethod(seed.get_quantum_seed)
        cls.generate_quantum_keypair = staticmethod(seed.generate_quantum_keypair)
        # Fixed master key for deterministic tests
        cls.master_key = bytes(range(64))

    def test_ml_dsa_seed_size(self):
        """ML-DSA-65 seed is 32 bytes."""
        seed = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        self.assertEqual(len(seed), 32)

    def test_slh_dsa_seed_size(self):
        """SLH-DSA seed is 48 bytes (3 * n=16)."""
        seed = self.get_quantum_seed(self.master_key, "slh-dsa-shake-128s")
        self.assertEqual(len(seed), 48)

    def test_deterministic(self):
        """Same inputs produce the same seed."""
        s1 = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        s2 = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        self.assertEqual(s1, s2)

    def test_different_algorithms_different_seeds(self):
        """ML-DSA and SLH-DSA seeds are completely independent."""
        ml_seed = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        slh_seed = self.get_quantum_seed(self.master_key, "slh-dsa-shake-128s")
        # First 32 bytes should differ (different domain tags)
        self.assertNotEqual(ml_seed, slh_seed[:32])

    def test_different_indexes_different_seeds(self):
        """Different key_index values produce different seeds."""
        s0 = self.get_quantum_seed(self.master_key, "ml-dsa-65", key_index=0)
        s1 = self.get_quantum_seed(self.master_key, "ml-dsa-65", key_index=1)
        self.assertNotEqual(s0, s1)

    def test_different_master_keys_different_seeds(self):
        """Different master keys produce different quantum seeds."""
        mk2 = bytes(range(63, -1, -1))
        s1 = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        s2 = self.get_quantum_seed(mk2, "ml-dsa-65")
        self.assertNotEqual(s1, s2)

    def test_wrong_master_key_length(self):
        """Rejects master key that is not 64 bytes."""
        with self.assertRaises(ValueError):
            self.get_quantum_seed(b"\x00" * 32, "ml-dsa-65")

    def test_unknown_algorithm(self):
        """Rejects unknown algorithm name."""
        with self.assertRaises(ValueError):
            self.get_quantum_seed(self.master_key, "unknown-algo")

    def test_full_pipeline_ml_dsa(self):
        """Full pipeline: master key -> quantum seed -> keygen -> sign -> verify."""
        from crypto.ml_dsa import ml_keygen, ml_sign, ml_verify

        quantum_seed = self.get_quantum_seed(self.master_key, "ml-dsa-65")
        sk, pk = ml_keygen(quantum_seed)
        msg = b"full pipeline test"
        sig = ml_sign(msg, sk)
        self.assertTrue(ml_verify(msg, sig, pk))

    def test_full_pipeline_slh_dsa(self):
        """Full pipeline: master key -> quantum seed -> keygen -> sign -> verify."""
        from crypto.slh_dsa import slh_keygen, slh_sign, slh_verify

        quantum_seed = self.get_quantum_seed(self.master_key, "slh-dsa-shake-128s")
        sk, pk = slh_keygen(quantum_seed)
        msg = b"full pipeline test"
        sig = slh_sign(msg, sk)
        self.assertTrue(slh_verify(msg, sig, pk))

    def test_generate_quantum_keypair_ml_dsa(self):
        """generate_quantum_keypair() produces valid ML-DSA keypair."""
        from crypto.ml_dsa import ml_sign, ml_verify, _SK_SIZE, _PK_SIZE

        sk, pk = self.generate_quantum_keypair(self.master_key, "ml-dsa-65")
        self.assertEqual(len(sk), _SK_SIZE)
        self.assertEqual(len(pk), _PK_SIZE)
        msg = b"keypair wrapper test"
        sig = ml_sign(msg, sk)
        self.assertTrue(ml_verify(msg, sig, pk))

    def test_generate_quantum_keypair_slh_dsa(self):
        """generate_quantum_keypair() produces valid SLH-DSA keypair."""
        from crypto.slh_dsa import slh_sign, slh_verify, _SK_SIZE, _PK_SIZE

        sk, pk = self.generate_quantum_keypair(self.master_key, "slh-dsa-shake-128s")
        self.assertEqual(len(sk), _SK_SIZE)
        self.assertEqual(len(pk), _PK_SIZE)
        msg = b"keypair wrapper test"
        sig = slh_sign(msg, sk)
        self.assertTrue(slh_verify(msg, sig, pk))

    def test_generate_quantum_keypair_deterministic(self):
        """Same inputs to generate_quantum_keypair() produce same keypair."""
        sk1, pk1 = self.generate_quantum_keypair(self.master_key, "ml-dsa-65")
        sk2, pk2 = self.generate_quantum_keypair(self.master_key, "ml-dsa-65")
        self.assertEqual(sk1, sk2)
        self.assertEqual(pk1, pk2)

    def test_generate_quantum_keypair_unknown_algo(self):
        """generate_quantum_keypair() rejects unknown algorithm."""
        with self.assertRaises(ValueError):
            self.generate_quantum_keypair(self.master_key, "unknown")

    def test_word_count_enforcement_24_rejected(self):
        """24-word seed is rejected when _word_count is passed."""
        with self.assertRaises(ValueError) as ctx:
            self.get_quantum_seed(self.master_key, "ml-dsa-65", _word_count=24)
        self.assertIn("36-word", str(ctx.exception))

    def test_word_count_enforcement_36_accepted(self):
        """36-word seed is accepted when _word_count is passed."""
        seed = self.get_quantum_seed(self.master_key, "ml-dsa-65", _word_count=36)
        self.assertEqual(len(seed), 32)

    def test_word_count_none_skips_check(self):
        """_word_count=None skips the entropy check (backward compat)."""
        seed = self.get_quantum_seed(self.master_key, "ml-dsa-65", _word_count=None)
        self.assertEqual(len(seed), 32)

    def test_generate_keypair_word_count_passthrough(self):
        """generate_quantum_keypair passes _word_count to get_quantum_seed."""
        with self.assertRaises(ValueError):
            self.generate_quantum_keypair(self.master_key, "ml-dsa-65", _word_count=24)


# ── Runner ─────────────────────────────────────────────────────────

if __name__ == "__main__":
    t0 = time.perf_counter()
    unittest.main(verbosity=2, exit=False)
    elapsed = time.perf_counter() - t0
    print(f"\nTotal time: {elapsed:.1f}s")
